rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Rules for receipt images
    match /receipts/{userId}/{category}/{fileName} {
      // Allow read/write only if user is authenticated and matches the userId in path
      allow read, write: if request.auth != null 
                      && request.auth.uid == userId
                      && isValidCategory(category)
                      && isValidReceiptImage(fileName);
      
      // Allow delete only for the owner
      allow delete: if request.auth != null 
                 && request.auth.uid == userId;
    }
    
    // Helper functions
    function isValidCategory(category) {
      return category in ['fuel', 'maintenance', 'expenses'];
    }
    
    function isValidReceiptImage(fileName) {
      // Check file extension
      return fileName.matches('.*\\.(jpg|jpeg|png|webp|gif)$')
          && resource.size < 5 * 1024 * 1024  // Max 5MB
          && request.resource.contentType.matches('image/.*');
    }
    
    // Deny all other access
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}