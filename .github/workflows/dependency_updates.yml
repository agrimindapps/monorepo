name: Dependency Updates

on:
  schedule:
    # Toda segunda-feira às 9h UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Permitir trigger manual

jobs:
  check-dependencies:
    name: Check Outdated Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        cache: true
    
    - name: Check for outdated dependencies
      id: outdated
      run: |
        echo "# Dependency Update Report" > report.md
        echo "" >> report.md
        echo "Generated: $(date)" >> report.md
        echo "" >> report.md
        
        # Verificar cada app
        for app in apps/*/; do
          app_name=$(basename "$app")
          echo "## $app_name" >> report.md
          echo "" >> report.md
          
          cd "$app"
          outdated=$(flutter pub outdated --json 2>/dev/null || echo '{}')
          
          if [ "$outdated" != "{}" ]; then
            echo "\`\`\`" >> ../../report.md
            flutter pub outdated >> ../../report.md 2>/dev/null || echo "No outdated dependencies"
            echo "\`\`\`" >> ../../report.md
          else
            echo "✅ All dependencies up to date" >> ../../report.md
          fi
          echo "" >> ../../report.md
          cd ../..
        done
        
        # Verificar core package
        echo "## Core Package" >> report.md
        echo "" >> report.md
        cd packages/core
        echo "\`\`\`" >> ../../report.md
        flutter pub outdated >> ../../report.md 2>/dev/null || echo "No outdated dependencies"
        echo "\`\`\`" >> ../../report.md
        cd ../..
    
    - name: Create issue with report
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('report.md', 'utf8');
          
          // Procurar issue existente
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['dependencies', 'automated'],
            state: 'open'
          });
          
          const title = '📦 Weekly Dependency Update Report';
          
          if (issues.data.length > 0) {
            // Atualizar issue existente
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issues.data[0].number,
              body: report
            });
          } else {
            // Criar nova issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: report,
              labels: ['dependencies', 'automated']
            });
          }

  update-dependencies:
    name: Auto-update Minor Dependencies
    runs-on: ubuntu-latest
    needs: check-dependencies
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
    
    - name: Update dependencies
      run: |
        # Atualizar apenas versões minor/patch (seguro)
        for app in apps/*/; do
          cd "$app"
          flutter pub upgrade --minor-only
          cd ../..
        done
        
        cd packages/core
        flutter pub upgrade --minor-only
        cd ../..
    
    - name: Run tests after upgrade
      run: |
        # Rodar quality gates para validar
        dart scripts/quality_gates.dart --app=all --check=all
    
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore: update minor dependencies'
        branch: automated/dependency-updates
        title: '📦 Automated Dependency Updates'
        body: |
          ## Automated Dependency Updates
          
          This PR updates minor and patch versions of dependencies across all apps.
          
          **Changes:**
          - Updated dependencies to latest minor/patch versions
          - All tests passing
          - Quality gates validated
          
          **Action Required:**
          - Review changes
          - Test manually if needed
          - Merge if everything looks good
          
          ---
          *This PR was generated automatically by the dependency update workflow*
        labels: |
          dependencies
          automated
          minor-update

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
    
    - name: Run security audit
      run: |
        echo "# Security Audit Report" > security_report.md
        echo "" >> security_report.md
        
        # Verificar dependências com vulnerabilidades conhecidas
        for app in apps/*/; do
          app_name=$(basename "$app")
          echo "## $app_name" >> security_report.md
          
          cd "$app"
          
          # Verificar pub audit (quando disponível)
          if flutter pub audit &> /dev/null; then
            flutter pub audit >> ../../security_report.md
          else
            echo "⚠️  Audit not available yet" >> ../../security_report.md
          fi
          
          cd ../..
        done
    
    - name: Upload security report
      uses: actions/upload-artifact@v3
      with:
        name: security-report
        path: security_report.md
    
    - name: Create security issue if vulnerabilities found
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('security_report.md', 'utf8');
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: '🔒 Security Vulnerabilities Detected',
            body: `## Security Alert\n\n${report}\n\n**Action Required:** Review and update vulnerable dependencies ASAP.`,
            labels: ['security', 'critical', 'automated']
          });
