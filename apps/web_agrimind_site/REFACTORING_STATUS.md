# Web Agrimind Site - Refactoring to Riverpod + Clean Architecture

## Status: FASE 1 COMPLETED ✅

### Overview
Migration from GetX/Provider to Riverpod with Clean Architecture following the `web_receituagro` reference pattern.

---

## FASE 1: Setup Dependencies and Core Infrastructure (COMPLETED)

### ✅ Completed Tasks

#### 1. Dependencies Updated (pubspec.yaml)
- **State Management**: `flutter_riverpod ^2.5.1`, `riverpod_annotation ^2.3.5`
- **Dependency Injection**: `get_it ^8.2.0`, `injectable ^2.4.4`
- **Functional Programming**: `dartz ^0.10.1`
- **Immutability**: `freezed_annotation ^2.4.1`, `equatable ^2.0.5`
- **Code Generation**: `build_runner ^2.4.13`, `riverpod_generator ^2.4.3`, `injectable_generator ^2.6.2`
- **Linting**: `custom_lint ^0.7.3`, `riverpod_lint ^2.3.13`
- **Testing**: `mocktail ^1.0.4`
- **Core Package**: Added dependency to `../../packages/core`

**Removed**: GetX (provider), Provider package (transitioned to Riverpod)

#### 2. Directory Structure Created
```
lib/
├── core/
│   ├── di/
│   │   └── injection.dart (GetIt + Injectable setup)
│   ├── error/
│   │   ├── failures.dart (Failure classes)
│   │   └── exceptions.dart (Exception classes)
│   ├── interfaces/
│   │   └── usecase.dart (UseCase base interface)
│   ├── constants/
│   │   └── constants.dart (App constants)
│   ├── router/ (TO BE IMPLEMENTED)
│   ├── validation/ (TO BE IMPLEMENTED)
│   └── widgets/ (TO BE IMPLEMENTED)
│
├── features/
│   ├── culturas/
│   │   ├── data/
│   │   │   ├── datasources/ (TO BE IMPLEMENTED - FASE 3)
│   │   │   ├── models/ (TO BE IMPLEMENTED - FASE 3)
│   │   │   └── repositories/ (TO BE IMPLEMENTED - FASE 3)
│   │   ├── domain/
│   │   │   ├── entities/
│   │   │   │   └── cultura_entity.dart ✅
│   │   │   ├── repositories/ (TO BE IMPLEMENTED - FASE 3)
│   │   │   └── usecases/ (TO BE IMPLEMENTED - FASE 3)
│   │   └── presentation/
│   │       ├── providers/
│   │       │   └── culturas_provider.dart ✅ (Placeholder)
│   │       ├── pages/ (TO BE IMPLEMENTED - FASE 4)
│   │       └── widgets/ (TO BE IMPLEMENTED - FASE 4)
│   │
│   ├── defensivos/ (Structure created, entity placeholder)
│   ├── pragas/ (Structure created, entity placeholder)
│   ├── fitossanitarios/ (Structure created, entity placeholder)
│   └── diagnostico/ (Structure created, entity placeholder)
│
└── shared/
    ├── widgets/ (TO BE IMPLEMENTED)
    ├── themes/ (Legacy - TO BE MIGRATED)
    └── utils/ (Legacy - TO BE MIGRATED)
```

#### 3. Core Infrastructure Files

**lib/core/error/failures.dart**
- Base `Failure` abstract class (Equatable)
- `ServerFailure`, `ValidationFailure`, `CacheFailure`, `NotFoundFailure`, `PermissionFailure`, `UnexpectedFailure`

**lib/core/error/exceptions.dart**
- Base `AppException` class
- `ServerException`, `CacheException`, `ValidationException`, `NotFoundException`, `PermissionException`

**lib/core/interfaces/usecase.dart**
- `UseCase<ReturnType, Params>` abstract interface
- `NoParams` class for parameterless use cases
- Returns `Future<Either<Failure, ReturnType>>`

**lib/core/di/injection.dart**
- GetIt instance setup
- `@InjectableInit` annotation
- `configureDependencies()` function
- NOTE: `injection.config.dart` will be generated by build_runner in FASE 2

**lib/core/constants/constants.dart**
- `ApiConstants` (baseUrl, timeout)
- `AppConstants` (appName, version, cache durations)
- `StorageKeys` (local storage keys)
- `Routes` (route names)

#### 4. Main App Setup

**lib/main.dart**
- Removed GetX dependency
- Added `ProviderScope` wrapper (Riverpod)
- Added `configureDependencies()` call for GetIt/Injectable
- Created `MyApp` as StatelessWidget (theme wrapper)
- Firebase and Supabase initialization maintained

**lib/app.dart**
- Converted from `StatefulWidget` to `ConsumerStatefulWidget`
- Changed `State<App>` to `ConsumerState<App>`
- `ref` now available for Riverpod providers
- Legacy router maintained (to be migrated in FASE 4)

#### 5. First Provider (Placeholder)

**lib/features/culturas/presentation/providers/culturas_provider.dart**
- Placeholder provider functions (not annotated yet)
- `culturas(ref)` - Returns empty list (to be implemented in FASE 3)
- `cultura(ref, id)` - Returns null (to be implemented in FASE 3)
- Documentation comments for future implementation

#### 6. Domain Entities Created

**lib/features/culturas/domain/entities/cultura_entity.dart**
- Complete CulturaEntity with Equatable
- Properties: id, nome, nomeComum, nomeCientifico, descricao, imageUrl, timestamps

**Other entities** (Placeholders for FASE 2-3):
- `defensivo_entity.dart`
- `praga_entity.dart`
- `fitossanitario_entity.dart`
- `diagnostico_entity.dart`

#### 7. Validation

- ✅ `flutter pub get` executed successfully (183 dependencies resolved)
- ✅ `flutter analyze` - **0 errors in new files** (46 issues total are from legacy code)
- ✅ New structure has zero analyzer errors
- ✅ All core infrastructure compiles successfully

---

## Next Steps: FASE 2

### FASE 2: Code Generation and Repository Setup (Est. 2-3 hours)

**Tasks:**
1. Run `build_runner` to generate:
   - `injection.config.dart` (Injectable DI)
   - `culturas_provider.g.dart` (Riverpod providers)
   - Freezed models (if needed)

2. Create Repository Interfaces:
   - `CulturasRepository` interface (domain layer)
   - `DefensivosRepository` interface
   - `PragasRepository` interface
   - `FitossanitariosRepository` interface

3. Create Data Models:
   - `CulturaModel` with JSON serialization
   - Extend/implement `CulturaEntity`
   - `fromJson()`, `toJson()`, `toEntity()` methods

4. Setup Injectable modules:
   - Supabase module
   - Firebase module (if needed)
   - HTTP client module (if needed)

**Command to run:**
```bash
cd /Users/agrimindsolucoes/Documents/GitHub/monorepo/apps/web_agrimind_site
dart run build_runner build --delete-conflicting-outputs
```

---

## Notes

### Architecture Pattern (Following web_receituagro)
- **Clean Architecture**: Strict 3-layer separation (Presentation/Domain/Data)
- **Either Pattern**: All repositories return `Either<Failure, T>` (dartz)
- **Riverpod**: Code generation with `@riverpod` annotations
- **GetIt + Injectable**: Dependency injection for services/repositories
- **AsyncValue**: State management for async operations

### File Naming Conventions
- Entities: `*_entity.dart` (domain layer)
- Models: `*_model.dart` (data layer)
- Repositories (interface): `*_repository.dart` (domain layer)
- Repositories (impl): `*_repository_impl.dart` (data layer)
- Providers: `*_provider.dart` (presentation layer)
- Use cases: `*_usecase.dart` (domain layer)

### Testing Strategy (FASE 5)
- Mocktail for mocking
- ProviderContainer for testing Riverpod providers (without widgets)
- Target coverage: ≥80% for use cases
- 5-7 tests per use case (success + validations + failures)

---

## Legacy Code Status

**Maintained (Unchanged):**
- `lib/app-site/*` - Legacy pages and repositories (will be migrated incrementally)
- `lib/services/*` - Firebase, Supabase, Analytics services
- `lib/themes/*` - Theme management (to be migrated to shared/)
- `lib/widgets/*` - Common widgets (to be migrated to shared/)
- `lib/pages/*` - Legacy pages (to be migrated per feature)

**To Be Removed:**
- GetX usage in legacy files
- Provider usage in legacy files
- Direct Supabase calls (to be abstracted through repositories)

---

**Last Updated**: 2025-11-03
**Status**: FASE 1 COMPLETED ✅
**Ready for**: FASE 2 (Code Generation and Repository Setup)
