rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ===== HEALTH CHECK =====
    match /_health_check/{document} {
      allow read, write: if request.auth != null;
    }

    // ===== USUÁRIOS =====
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // ===== SUBCOLEÇÕES DO USUÁRIO =====
      
      // Dispositivos do usuário
      match /devices/{deviceId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // Dados de diagnósticos/receitas do usuário
      match /diagnoses/{diagnosisId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // Histórico de consultas
      match /consultations/{consultationId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // Preferências e configurações
      match /preferences/{prefId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // Cache local de dados estáticos
      match /cached_data/{cacheId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // ===== COLEÇÕES RAIZ (caso existam) =====
    
    // Dispositivos na raiz (compatibilidade)
    match /devices/{deviceId} {
      allow read, write: if request.auth != null &&
        request.auth.uid == resource.data.user_id;
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.user_id;
    }

    // Diagnósticos na raiz (compatibilidade)
    match /diagnoses/{diagnosisId} {
      allow read, write: if request.auth != null &&
        request.auth.uid == resource.data.user_id;
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.user_id;
    }

    // Consultas na raiz (compatibilidade)
    match /consultations/{consultationId} {
      allow read, write: if request.auth != null &&
        request.auth.uid == resource.data.user_id;
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.user_id;
    }

    // ===== SINCRONIZAÇÃO =====
    
    // Fila de sincronização - usuários só podem acessar suas próprias operações
    match /sync_queue/{syncId} {
      allow read, write: if request.auth != null &&
        request.auth.uid == resource.data.userId;
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.userId;
    }

    // Conflitos de sincronização - usuários só podem acessar seus próprios conflitos
    match /sync_conflicts/{conflictId} {
      allow read, write: if request.auth != null &&
        request.auth.uid == resource.data.userId;
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.userId;
    }

    // ===== DADOS ESTÁTICOS (somente leitura) =====
    
    // Base de dados de pragas, doenças, etc. - dados públicos
    match /static_data/{collection}/{document} {
      allow read: if request.auth != null;
    }

    // Dados de referência - catálogos, sintomas, etc.
    match /reference_data/{category}/{itemId} {
      allow read: if request.auth != null;
    }

    // Metadados do aplicativo
    match /app_metadata/{metaId} {
      allow read: if request.auth != null;
    }

    // ===== ASSINATURAS =====
    match /subscriptions/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
    }

    // ===== DADOS DE SINCRONIZAÇÃO =====
    match /syncData/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ===== CONFIGURAÇÕES =====
    match /userSettings/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ===== ANALYTICS E LOGS (somente escrita) =====
    
    // Logs de uso e analytics - usuários só podem escrever seus próprios logs
    match /analytics/{userId}/{document=**} {
      allow create: if request.auth != null && request.auth.uid == userId;
    }

    // Logs de erro e crash reports
    match /error_logs/{userId}/{logId} {
      allow create: if request.auth != null && request.auth.uid == userId;
    }

    // ===== CACHE E PERFORMANCE =====
    
    // Cache de dados processados por usuário
    match /user_cache/{userId}/{cacheKey} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ===== BLOQUEAR TODO O RESTO =====
    match /{document=**} {
      allow read, write: if false;
    }
  }
}